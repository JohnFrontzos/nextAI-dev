# Fix Docs Output Path

## Overview

The analyze command currently outputs documentation to `.nextai/` instead of `nextai/docs/` on fresh projects due to ambiguous path notation in the command template. This bug fix clarifies the path distinction to ensure documentation is always written to the correct user-facing directory.

## Requirements Summary

From investigation and initialization documents:

1. Documentation generated by `/nextai-analyze` must be saved to `nextai/docs/`
2. The bug occurs consistently on fresh/newly initialized projects
3. Root cause identified: inconsistent path notation in `.nextai/templates/commands/analyze.md` creates AI confusion between `.nextai/` (internal state) and `nextai/` (user-facing workspace)
4. Fix must preserve existing functionality (session context reading from `.nextai/state/`)
5. Fix must be verifiable on fresh project initialization

## Technical Approach

The fix adds explicit path distinction and clarification to the analyze command template to eliminate ambiguity for the AI agent:

1. **Enhanced Context Section**: Add explicit distinction between `.nextai/` (internal state) and `nextai/docs/` (output location)
2. **Reinforced Instructions**: Add explicit clarification in the instructions to prevent confusion
3. **Validation in Completion**: Add reminder in completion message to catch and flag incorrect output location

This approach uses **explicit instruction reinforcement** rather than code changes, as the issue is prompt ambiguity rather than logic error.

## Architecture

### Affected Components

- `.nextai/templates/commands/analyze.md` - Command template requiring clarification
- Document-writer subagent - Receives clarified context
- Documentation-recaps skill - Already has correct path (`nextai/docs/`), but relies on command context

### Directory Structure Context

```
project-root/
├── .nextai/                  # Internal state (hidden from users)
│   ├── state/
│   │   └── session.json     # Read-only context for commands
│   ├── templates/
│   └── agents/
└── nextai/                   # User-facing workspace
    ├── docs/                 # Documentation output (CORRECT TARGET)
    ├── todo/
    └── done/
```

### Data Flow

```
User runs /nextai-analyze
    ↓
Analyze command template loads
    ↓
Pre-flight: Read .nextai/state/session.json (✓ correct)
    ↓
Delegate to document-writer subagent with CLARIFIED context:
  - Internal state: .nextai/ (read-only)
  - Output location: nextai/docs/ (NOT .nextai/)
    ↓
Document-writer loads documentation-recaps skill
    ↓
Skill instructions: "Create/update files in nextai/docs/"
    ↓
Documentation written to nextai/docs/ (✓ correct)
    ↓
Completion message validates output location
```

## Implementation Details

### Changes to analyze.md

**Location**: `.nextai/templates/commands/analyze.md`

#### Change 1: Enhanced Context Section (Line 30-33)

**Current:**
```markdown
**Context to provide the document-writer subagent:**
- Mode: **Analyze Mode** (scan project + generate docs)
- Output location: `nextai/docs/`
- Project root: current directory
```

**Updated:**
```markdown
**Context to provide the document-writer subagent:**
- Mode: **Analyze Mode** (scan project + generate docs)
- Output location: `nextai/docs/` (user-facing docs, NOT .nextai/)
- Project root: current directory
- Internal state location: `.nextai/` (for reading session.json only, do NOT write docs here)
```

#### Change 2: Reinforced Instructions (Line 43-46)

**Current:**
```markdown
Then proceed with your workflow:
1. Scan project structure and technologies
2. Generate/update documentation files in nextai/docs/
3. Follow the skill's preservation rules and merge strategies
```

**Updated:**
```markdown
Then proceed with your workflow:
1. Scan project structure and technologies
2. Generate/update documentation files in nextai/docs/ (NOT in .nextai/ or .nextai/docs/)
3. Follow the skill's preservation rules and merge strategies

IMPORTANT: Documentation must be written to nextai/docs/ (user-facing directory).
The .nextai/ directory is for internal state only - never write documentation there.
```

#### Change 3: Validation in Completion (Line 50-56)

**Current:**
```markdown
## Completion

✓ Project documentation generated/updated.

Location: nextai/docs/

Review and customize the documentation as needed.
```

**Updated:**
```markdown
## Completion

Before reporting completion, verify documentation location:
- Documentation should be in `nextai/docs/` (✓ correct)
- If documentation was written to `.nextai/` or `.nextai/docs/` (✗ incorrect)

✓ Project documentation generated/updated.

Location: nextai/docs/

Review and customize the documentation as needed.
```

## API/Interface Changes

None. This fix modifies internal command template instructions only, with no changes to:
- CLI command signatures
- File schemas
- External APIs
- Agent interfaces

## Data Model

No data model changes required. The fix operates entirely at the instruction/prompt level.

## Security Considerations

This fix has no security implications:
- No new file permissions or access patterns
- No credential handling
- No external network access
- Template changes are deterministic and predictable

The fix actually improves security hygiene by clarifying the separation between:
- `.nextai/` - Internal state (should not contain user-editable content)
- `nextai/` - User workspace (appropriate location for documentation)

## Error Handling

### Detection

The completion message now includes explicit validation guidance to help the AI self-check output location before reporting completion.

### Recovery

If documentation is still written to wrong location after fix:
1. User notices docs in `.nextai/` instead of `nextai/docs/`
2. User can manually move files: `mv .nextai/docs/* nextai/docs/`
3. User reports persistent issue for deeper investigation

### Prevention

The multi-layered clarification approach (context + instructions + completion validation) creates redundancy to prevent the error:
1. **Context layer**: Explicit distinction in delegation context
2. **Instruction layer**: Reinforced in workflow steps
3. **Validation layer**: Self-check before completion

## Testing Strategy

### Manual Testing

1. **Fresh Project Test**:
   ```bash
   # Create test directory
   mkdir test-nextai-fresh
   cd test-nextai-fresh

   # Initialize NextAI
   nextai init

   # Run analyze command
   # (In AI client) /nextai-analyze

   # Verify output location
   ls nextai/docs/           # Should contain: index.md, architecture.md, etc.
   ls .nextai/docs/ 2>&1     # Should not exist or be empty
   ```

2. **Existing Project Test**:
   ```bash
   # Use existing NextAI project with docs
   cd existing-nextai-project

   # Run analyze to update
   # (In AI client) /nextai-analyze

   # Verify docs updated in correct location
   ls -la nextai/docs/       # Should show recent timestamps
   git diff nextai/docs/     # Should show documentation updates
   ```

3. **Session Context Test**:
   ```bash
   # Verify session.json is still read correctly
   cat .nextai/state/session.json
   # Run analyze and verify timestamp is used in output
   ```

### Automated Testing

This fix does not require unit tests because:
1. It modifies template content (prose/instructions), not code logic
2. The template is copied during sync, not executed programmatically
3. Testing would require LLM-in-the-loop to verify AI interpretation

However, the existing test suite should continue to pass:
```bash
npm test                    # All existing tests should pass
```

### Regression Testing

Verify no regressions in related commands that reference both path types:
- `/nextai-complete` - Uses document-writer agent
- `/nextai-implement` - References feature paths
- `/nextai-refine` - Creates spec files

## Alternatives Considered

### Alternative 1: Code-Based Path Validation

**Approach**: Add TypeScript code to validate output location after command completion.

**Pros**:
- Guaranteed enforcement
- Can auto-correct wrong location

**Cons**:
- Requires changes to command execution pipeline
- More complex implementation
- Doesn't address root cause (AI confusion)
- Overkill for prompt clarity issue

**Rejected because**: The issue is prompt ambiguity, not missing validation. Adding code complexity doesn't fix the underlying instruction problem.

### Alternative 2: Absolute Paths

**Approach**: Use absolute paths (e.g., `process.cwd() + '/nextai/docs/'`) instead of relative paths.

**Pros**:
- Eliminates path resolution ambiguity
- Works regardless of AI interpretation

**Cons**:
- Requires dynamic path injection into templates
- Makes templates less readable
- Breaks template portability
- Over-engineers a simple clarification problem

**Rejected because**: Relative paths are clearer and more maintainable. The issue is lack of distinction, not path resolution mechanics.

### Alternative 3: Rename .nextai/ to .nextai-internal/

**Approach**: Rename the internal directory to make the distinction more obvious.

**Pros**:
- Extremely clear naming
- Eliminates naming similarity

**Cons**:
- Breaking change for all existing projects
- Requires migration path
- Doesn't address instruction clarity
- Massive scope increase

**Rejected because**: This is architectural overkill for an instruction clarity bug. The chosen solution maintains backward compatibility while achieving the same clarity goal.

### Alternative 4: Separate Context and Output Instructions

**Approach**: Split pre-flight checks and output instructions into separate sections.

**Pros**:
- Clear separation of concerns
- Reduces cognitive load

**Cons**:
- Requires template restructuring
- May affect other commands using similar structure
- Doesn't fundamentally improve clarity more than chosen solution

**Partially adopted**: The chosen solution does add more separation by adding explicit "Internal state location" context, achieving the key benefit without major restructuring.

## Success Criteria

The fix is successful when:

1. Fresh project test produces docs in `nextai/docs/` (not `.nextai/`)
2. Session context reading from `.nextai/state/session.json` still works
3. Existing projects can update docs without issues
4. Related commands (complete, implement) continue working
5. No user-reported regressions after deployment

## Follow-up Work

### Immediate
None. This fix is self-contained.

### Future Considerations

1. **Template Review**: Apply similar clarification pattern to other command templates that reference both path types (`complete.md`, `implement.md`, `refine.md`)

2. **Documentation**: Add "Directory Structure" guide to explain `.nextai/` vs `nextai/` distinction for users and future template authors

3. **Validation Framework**: Consider adding optional post-command validation hooks for commands that write files to specific locations
