# Coding Conventions

## Code Style

### TypeScript

- **Target**: ES2022 with ESM modules
- **Strict mode**: Enabled (`strict: true`)
- **No unused**: `noUnusedLocals` and `noUnusedParameters` enforced

### Formatting

- Use consistent indentation (2 spaces recommended)
- Single quotes for strings
- Semicolons at end of statements
- Trailing commas in multiline objects/arrays

### Exports

- Prefer named exports over default exports
- Re-export from index files for clean public APIs:

```typescript
// src/schemas/index.ts
export * from './ledger.js';
export * from './config.js';
```

### Imports

- Use `.js` extension for local imports (ESM requirement):

```typescript
import { loadLedger } from '../utils/config.js';
```

- Group imports: external packages first, then local modules

## Naming Conventions

### Files

| Type | Convention | Example |
|------|------------|---------|
| Source files | kebab-case | `phase-validators.ts` |
| Test files | `*.test.ts` suffix | `ledger.test.ts` |
| Directories | kebab-case | `cli/utils/` |

### Code

| Type | Convention | Example |
|------|------------|---------|
| Functions | camelCase | `addFeature()` |
| Variables | camelCase | `featureId` |
| Constants | UPPER_SNAKE_CASE | `PHASE_ORDER` |
| Types/Interfaces | PascalCase | `PhaseUpdateResult` |
| Zod schemas | PascalCase + Schema | `LedgerSchema` |
| Classes | PascalCase | `ClaudeCodeConfigurator` |

### Feature IDs

Format: `YYYYMMDD_short-slug`

```
20251208_add-user-auth
20251208_fix-login-bug
```

Generated by `generateFeatureId()` in `src/schemas/ledger.ts`.

### Version Numbers

Follow semantic versioning (semver):
- **Major** (x.0.0): Breaking changes
- **Minor** (0.x.0): New features, backward compatible
- **Patch** (0.0.x): Bug fixes, backward compatible

Version comparison logic in `src/core/sync/version.ts` handles upgrade/downgrade detection.

## File Organization

### Source Structure

```
src/
├── cli/                    # CLI layer
│   ├── index.ts            # Entry point
│   ├── commands/           # Command handlers
│   └── utils/              # CLI utilities
│
├── core/                   # Business logic
│   ├── scaffolding/        # File/folder creation
│   ├── state/              # Ledger, history management
│   ├── sync/               # AI client sync adapters
│   └── validation/         # Phase validators
│
├── schemas/                # Zod schemas
│   ├── ledger.ts
│   ├── config.ts
│   └── ...
│
├── types/                  # TypeScript type definitions
│   └── index.ts
│
└── index.ts                # Public API exports
```

### Test Structure

Mirror the source structure:

```
tests/
├── unit/
│   ├── cli/utils/          # Matches src/cli/utils/
│   ├── core/state/         # Matches src/core/state/
│   └── schemas/            # Matches src/schemas/
├── integration/
│   └── cli/                # CLI integration tests
└── e2e/                    # Full workflow tests
```

### Resources Structure

Bundled templates (copied during init):

```
resources/
├── agents/                 # Agent markdown files (auto-discovered)
├── skills/                 # Skill directories (auto-discovered, flat structure)
│   ├── documentation-recaps/
│   ├── executing-plans/
│   └── ...
└── templates/
    └── commands/           # Command templates (auto-discovered)
```

**Auto-Discovery Rules:**
- All `.md` files in `resources/agents/` are automatically synced
- All directories in `resources/skills/` containing `SKILL.md` are automatically synced
- All `.md` files in `resources/templates/commands/` are automatically synced
- No manifest files to update - just add files and they're discovered

**Important:** Skills must be direct children of `resources/skills/`. Claude Code only discovers skills at the root level, not in subdirectories.

## Git Workflow

### Branches

- `main` - Production-ready code
- Feature branches for development

### Commits

Keep commits focused and atomic. Use conventional commit style:

```
feat: Add password reset workflow
fix: Correct phase transition validation
docs: Update architecture documentation
refactor: Extract sync adapter base class
test: Add ledger unit tests
```

### What to Commit

- Source code changes
- Test updates
- Documentation updates
- Configuration changes

### What NOT to Commit

- `node_modules/`
- `dist/` (build output)
- `.env` files
- OS-specific files (`.DS_Store`)
- IDE settings (unless shared)

## Error Handling

### CLI Errors

Use the logger utilities from `src/cli/utils/logger.ts`:

```typescript
import { logError, logWarning, logSuccess } from '../utils/logger.js';

logError('Feature not found');
logWarning('Using default configuration');
logSuccess('Feature created');
```

### Validation Errors

Return structured results:

```typescript
interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}
```

### Phase Transitions

Return structured results with optional bypass info:

```typescript
interface PhaseUpdateResult {
  success: boolean;
  error?: string;
  errors?: string[];
  warnings?: string[];
  bypassed?: boolean;
}
```

## Testing Guidelines

### Unit Tests

- Test one function/module at a time
- Mock external dependencies
- Use descriptive test names

```typescript
describe('generateFeatureId', () => {
  it('creates ID with date prefix and slugified title', () => {
    // ...
  });
});
```

### Integration Tests

- Test multiple modules working together
- Use test fixtures for consistent data
- Clean up after tests

### Test Utilities

Use helpers from `tests/helpers/test-utils.ts`:

```typescript
import { createTestFeature, cleanupTestDir } from '../helpers/test-utils.js';
```

## Documentation

### Code Comments

- Prefer self-documenting code over comments
- Use JSDoc for public API functions
- Explain "why" not "what"

### Markdown Files

- Use ATX-style headers (`#`, `##`, `###`)
- Include code blocks with language hints
- Keep lines under 100 characters when practical

### Feature Artifacts

Follow the artifact templates:

| File | Purpose | Key Sections |
|------|---------|--------------|
| `initialization.md` | Original request | Idea, context |
| `requirements.md` | Q&A results | Questions, answers |
| `spec.md` | Technical spec | Overview, implementation, testing |
| `tasks.md` | Implementation checklist | Implementation tasks only (no manual verification) |
| `testing.md` | Manual test checklist and session log | Manual Test Checklist, Test Sessions |
| `review.md` | Review results | Verdict, findings |
| `summary.md` | Completion summary | Changes, highlights |

## Command Template Conventions

### Subagent Skill Loading

When command templates delegate to subagents, they must explicitly instruct the subagent to load its assigned skills before beginning work. This ensures subagents have access to their specialized skill instructions.

**Pattern:**

```markdown
**Instructions for the [subagent] subagent:**

FIRST ACTION - Load Your Skill:
Before starting [task], you MUST load your assigned skill:
1. Use the Skill tool: Skill("[skill-name]")
2. This skill provides [description]
3. Follow the skill's guidance throughout your work

Then proceed with your workflow:

1. [Step 1]
2. [Step 2]
...
```

**Agent-Skill Mappings:**

| Agent | Skills | Usage |
|-------|--------|-------|
| developer | executing-plans | Implementation task execution |
| product-owner | refinement-product | Product requirements gathering Q&A |
| technical-architect | refinement-technical | Codebase analysis, technical Q&A, spec authoring (spec.md, tasks.md, testing.md) |
| reviewer | reviewer-checklist | Code review validation |
| document-writer | documentation-recaps | Summary and docs updates |
| investigator | root-cause-tracing, systematic-debugging, testing-investigator | Bug and test failure investigation |

**Note:** Skills must be direct children of `.claude/skills/` (no subdirectories). Use bare skill names without namespace prefixes when invoking skills.

## Development Workflow

### Making Changes

1. Create feature branch from `main`
2. Make focused, atomic commits
3. Run tests: `npm test`
4. Run linting: `npm run lint`
5. Type check: `npm run typecheck`
6. Build to verify: `npm run build`

### Before Committing

Ensure the following pass:
```bash
npm run typecheck && npm run lint && npm test && npm run build
```

### Publishing Workflow

1. Update version in `package.json`
2. Commit changes
3. Create git tag: `git tag v0.1.0`
4. Push tag: `git push origin v0.1.0`
5. GitHub Actions automatically publishes to npm

### Test Session Logging Format

When using the /testing command, test sessions are logged to testing.md with sequential numbering:

```markdown
## Test Sessions

### Session 1 - 2025-12-21 10:30
**Status:** PASS
**Notes:** All features working as expected

**Attachments:**
- attachments/evidence/screenshot-1.png

### Session 2 - 2025-12-21 14:15
**Status:** FAIL
**Notes:** Button doesn't work on Android 12

**Attachments:**
- attachments/evidence/android-screenshot.png

#### Investigation Report
**Root Cause:** Missing null check in handleClick()
**Affected Files:** src/components/Button.tsx:45
**Suggested Fix:** Add null check before accessing property
```

**Conventions:**
- Session numbers increment sequentially (1, 2, 3...)
- Timestamps use ISO format with local time
- Status is either PASS or FAIL
- Investigation reports are automatically added for FAIL sessions
- Attachments folder (attachments/evidence/) is auto-checked

<!-- Updated: 2025-12-21 - Added test session logging format, testing-investigator skill, tasks.md/testing.md separation -->

## Metrics Logging Conventions

### Metrics Files Location

Metrics are stored in `nextai/metrics/` in JSONL (JSON Lines) format:
- One JSON object per line
- Each line is independent and parsable
- Suitable for streaming analysis

### Spec Change Metrics

File: `nextai/metrics/spec-changes.jsonl`

**Fields:**
```typescript
{
  timestamp: string;        // ISO 8601 timestamp
  feature_id: string;       // YYYYMMDD_slug format
  failure_description: string; // From test notes
  user_decision: 'approved' | 'declined' | 'cancelled';
  original_phase: string;   // Phase when failure occurred
}
```

**Example:**
```json
{"timestamp":"2025-12-21T10:30:00.000Z","feature_id":"20251221_handle-spec-changes-in-testing","failure_description":"Button doesn't work on mobile","user_decision":"approved","original_phase":"testing"}
```

**Usage:**
Append entries as spec change events occur. Use for:
- Tracking spec change frequency
- Analyzing approval patterns
- Understanding phase dynamics

### Metrics Writing Pattern

All metrics writers follow the same pattern:

```typescript
import { appendFileSync } from 'fs';
import { join } from 'path';

function logMetric(projectRoot: string, metric: object): void {
  const metricsDir = join(projectRoot, 'nextai', 'metrics');
  const metricsFile = join(metricsDir, 'metric-name.jsonl');
  
  try {
    appendFileSync(metricsFile, JSON.stringify(metric) + '\n', 'utf-8');
  } catch (error) {
    // Log warning but don't block workflow
    console.warn('Failed to write metrics:', error);
  }
}
```

**Key Principles:**
- Non-blocking: Metrics failures don't stop the workflow
- Append-only: New entries added without overwriting
- JSONL format: One entry per line for easy parsing
- Timestamp always included for chronological analysis

<!-- Updated: 2025-12-21 - Added metrics logging conventions and spec change metrics documentation -->
