# Coding Conventions

## Code Style

### TypeScript

- **Target**: ES2022 with ESM modules
- **Strict mode**: Enabled (`strict: true`)
- **No unused**: `noUnusedLocals` and `noUnusedParameters` enforced

### Formatting

- Use consistent indentation (2 spaces recommended)
- Single quotes for strings
- Semicolons at end of statements
- Trailing commas in multiline objects/arrays

### Exports

- Prefer named exports over default exports
- Re-export from index files for clean public APIs:

```typescript
// src/schemas/index.ts
export * from './ledger.js';
export * from './config.js';
```

### Imports

- Use `.js` extension for local imports (ESM requirement):

```typescript
import { loadLedger } from '../utils/config.js';
```

- Group imports: external packages first, then local modules

## Naming Conventions

### Files

| Type | Convention | Example |
|------|------------|---------|
| Source files | kebab-case | `phase-validators.ts` |
| Test files | `*.test.ts` suffix | `ledger.test.ts` |
| Directories | kebab-case | `cli/utils/` |

### Code

| Type | Convention | Example |
|------|------------|---------|
| Functions | camelCase | `addFeature()` |
| Variables | camelCase | `featureId` |
| Constants | UPPER_SNAKE_CASE | `PHASE_ORDER` |
| Types/Interfaces | PascalCase | `PhaseUpdateResult` |
| Zod schemas | PascalCase + Schema | `LedgerSchema` |
| Classes | PascalCase | `ClaudeCodeConfigurator` |

### Feature IDs

Format: `YYYYMMDD_short-slug`

```
20251208_add-user-auth
20251208_fix-login-bug
```

Generated by `generateFeatureId()` in `src/schemas/ledger.ts`.

## File Organization

### Source Structure

```
src/
├── cli/                    # CLI layer
│   ├── index.ts            # Entry point
│   ├── commands/           # Command handlers
│   └── utils/              # CLI utilities
│
├── core/                   # Business logic
│   ├── scaffolding/        # File/folder creation
│   ├── state/              # Ledger, history management
│   ├── sync/               # AI client sync adapters
│   └── validation/         # Phase validators
│
├── schemas/                # Zod schemas
│   ├── ledger.ts
│   ├── config.ts
│   └── ...
│
├── types/                  # TypeScript type definitions
│   └── index.ts
│
└── index.ts                # Public API exports
```

### Test Structure

Mirror the source structure:

```
tests/
├── unit/
│   ├── cli/utils/          # Matches src/cli/utils/
│   ├── core/state/         # Matches src/core/state/
│   └── schemas/            # Matches src/schemas/
├── integration/
│   └── cli/                # CLI integration tests
└── e2e/                    # Full workflow tests
```

### Resources Structure

Bundled templates (copied during init):

```
resources/
├── agents/                 # Agent markdown files
├── skills/                 # Skill directories (flat, no subdirectories)
│   ├── documentation-recaps/
│   ├── executing-plans/
│   └── ...
└── templates/
    └── commands/           # Command templates
```

**Important:** Skills must be direct children of `resources/skills/`. Claude Code only discovers skills at the root level, not in subdirectories.

## Git Workflow

### Branches

- `main` - Production-ready code
- Feature branches for development

### Commits

Keep commits focused and atomic. Use conventional commit style:

```
feat: Add password reset workflow
fix: Correct phase transition validation
docs: Update architecture documentation
refactor: Extract sync adapter base class
test: Add ledger unit tests
```

### What to Commit

- Source code changes
- Test updates
- Documentation updates
- Configuration changes

### What NOT to Commit

- `node_modules/`
- `dist/` (build output)
- `.env` files
- OS-specific files (`.DS_Store`)
- IDE settings (unless shared)

## Error Handling

### CLI Errors

Use the logger utilities from `src/cli/utils/logger.ts`:

```typescript
import { logError, logWarning, logSuccess } from '../utils/logger.js';

logError('Feature not found');
logWarning('Using default configuration');
logSuccess('Feature created');
```

### Validation Errors

Return structured results:

```typescript
interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}
```

### Phase Transitions

Return structured results with optional bypass info:

```typescript
interface PhaseUpdateResult {
  success: boolean;
  error?: string;
  errors?: string[];
  warnings?: string[];
  bypassed?: boolean;
}
```

## Testing Guidelines

### Unit Tests

- Test one function/module at a time
- Mock external dependencies
- Use descriptive test names

```typescript
describe('generateFeatureId', () => {
  it('creates ID with date prefix and slugified title', () => {
    // ...
  });
});
```

### Integration Tests

- Test multiple modules working together
- Use test fixtures for consistent data
- Clean up after tests

### Test Utilities

Use helpers from `tests/helpers/test-utils.ts`:

```typescript
import { createTestFeature, cleanupTestDir } from '../helpers/test-utils.js';
```

## Documentation

### Code Comments

- Prefer self-documenting code over comments
- Use JSDoc for public API functions
- Explain "why" not "what"

### Markdown Files

- Use ATX-style headers (`#`, `##`, `###`)
- Include code blocks with language hints
- Keep lines under 100 characters when practical

### Feature Artifacts

Follow the artifact templates:

| File | Purpose | Key Sections |
|------|---------|--------------|
| `initialization.md` | Original request | Idea, context |
| `requirements.md` | Q&A results | Questions, answers |
| `spec.md` | Technical spec | Overview, implementation, testing |
| `tasks.md` | Checklist | Ordered task list |
| `review.md` | Review results | Verdict, findings |
| `testing.md` | Test log | Results, notes |
| `summary.md` | Completion summary | Changes, highlights |

## Command Template Conventions

### Subagent Skill Loading

When command templates delegate to subagents, they must explicitly instruct the subagent to load its assigned skills before beginning work. This ensures subagents have access to their specialized skill instructions.

**Pattern:**

```markdown
**Instructions for the [subagent] subagent:**

FIRST ACTION - Load Your Skill:
Before starting [task], you MUST load your assigned skill:
1. Use the Skill tool: Skill("[skill-name]")
2. This skill provides [description]
3. Follow the skill's guidance throughout your work

Then proceed with your workflow:

1. [Step 1]
2. [Step 2]
...
```

**Agent-Skill Mappings:**

| Agent | Skills | Usage |
|-------|--------|-------|
| developer | executing-plans | Implementation task execution |
| product-owner | refinement-questions | Requirements gathering Q&A |
| technical-architect | refinement-spec-writer | Spec and task authoring |
| reviewer | reviewer-checklist | Code review validation |
| document-writer | documentation-recaps | Summary and docs updates |
| investigator | root-cause-tracing, systematic-debugging | Bug investigation |

**Note:** Skills must be direct children of `.claude/skills/` (no subdirectories). Use bare skill names without namespace prefixes when invoking skills.

<!-- Updated: 2025-12-09 - Removed namespace prefixes, documented flat directory requirement -->
